<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outfit Suggestions - PETI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
        <a class="navbar-brand" href="/dashboard">
            <i class="fas fa-tshirt me-2"></i>PETI
        </a>
        <div class="navbar-nav me-auto">
            <!-- Admin-only items with admin-link class -->
            <a class="nav-link admin-link" href="/api/page/adminDashboard">
                <i class="fas fa-tachometer-alt me-1"></i>Dashboard
            </a>
            <a class="nav-link" href="/api/page/dashboard">
                <i class="fa fa-shopping-bag me-1"></i>Wardrobe
            </a>
            <a class="nav-link admin-link" th:href="@{/api/page/users}">
                <i class="fas fa-users-cog me-1"></i>User Management
            </a>
            <a class="nav-link admin-link" href="/api/page/category">
                <i class="fas fa-tags me-1"></i>Category
            </a>
            <a class="nav-link" href="/api/page/addItem">
                <i class="fas fa-tshirt me-1"></i>Clothing Item
            </a>
            <!-- End of admin-only items -->
<!--            <a class="nav-link" href="/api/page/outfits">-->
<!--                <i class="fa fa-black-tie me-1"></i>Outfits-->
<!--            </a>-->

            <a class="nav-link" href="/api/page/analytics">
                <i class="fas fa-chart-bar me-1"></i>Analytics
            </a>
        </div>
        <ul class="navbar-nav">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                    <i class="fas fa-user me-1"></i>
                    <span id="usernameDisplay"></span>
                </a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="/api/page/profile"> <i class="fas fa-user me-2"></i>Profile</a></li>
                    <li> <a class="dropdown-item" href="/api/page/reports">
                        <i class="fas fa-flag me-2"></i>Reports
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" onclick="logout()"> <i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                </ul>
            </li>
        </ul>
    </div>
</nav>
<script src="/js/navbar.js"></script>
<div class="page-header container-fluid mt-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-4">
                    <i class="fas fa-lightbulb me-3"></i>Outfit Suggestions
                </h1>
                <p class="lead">Get personalized outfit recommendations</p>
            </div>
            <div class="col-md-4 text-end">
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#outfitModal">
                    <i class="fas fa-magic me-2"></i>Generate Suggestion
                </button>
            </div>
        </div>
    </div>
</div>

<main class="container">
    <!-- Toast Notifications -->
    <div class="toast-container">
        <div id="successToast" class="toast toast-success" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body d-flex justify-content-between align-items-center">
                <span><i class="fas fa-check-circle me-2"></i><span id="successMessage"></span></span>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
        <div id="errorToast" class="toast toast-error" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body d-flex justify-content-between align-items-center">
                <span><i class="fas fa-exclamation-circle me-2"></i><span id="errorMessageToast"></span></span>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Items Table -->
    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Color</th>
                    <th>Season</th>
                    <th>Occasion</th>
                    <th>Usage Count</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="itemsTableBody">
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <i class="fas fa-box-open fa-2x mb-2" style="color: var(--primary-light);"></i>
                        <p class="mb-2">No items found</p>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#outfitModal">
                            <i class="fas fa-magic me-2"></i>Generate Your First Suggestion
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<!-- Outfit Suggestion Modal -->
<div class="modal fade" id="outfitModal" tabindex="-1" aria-labelledby="outfitModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="outfitModalLabel">
                    <i class="fas fa-magic me-2"></i>Generate Outfit Suggestion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body outfit-form">
                <form id="outfitForm">
                    <div class="form-group mb-3">
                        <label for="occasion" class="form-label">Occasion</label>
                        <select class="form-select" id="occasion" required>
                            <option value="">Select an occasion</option>
                            <option value="CASUAL">Casual</option>
                            <option value="BUSINESS">Business</option>
                            <option value="FORMAL">Formal</option>
                            <option value="SPORT">Sport</option>
                            <option value="PARTY">Party</option>
                            <option value="BEACH">Beach</option>
                            <option value="HIKING">Hiking</option>
                            <option value="SLEEP">Sleep</option>
                        </select>
                    </div>

                    <div class="form-group mb-3">
                        <label for="season" class="form-label">Season</label>
                        <select class="form-select" id="season" required>
                            <option value="">Select a season</option>
                            <option value="SPRING">Spring</option>
                            <option value="SUMMER">Summer</option>
                            <option value="FALL">Fall</option>
                            <option value="WINTER">Winter</option>
                            <option value="ALL_SEASON">All Season</option>
                        </select>
                    </div>

                    <div class="form-group form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="weather">
                        <label class="form-check-label" for="weather">Consider current weather</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="generateOutfitBtn">
                    <i class="fas fa-magic me-2"></i>Generate
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Initialize toast notifications
    const successToast = new bootstrap.Toast(document.getElementById('successToast'));
    const errorToast = new bootstrap.Toast(document.getElementById('errorToast'));

    // Function to show success message
    function showSuccessMessage(message) {
        document.getElementById('successMessage').textContent = message;
        successToast.show();
    }

    // Function to show error message
    function showErrorMessage(message) {
        document.getElementById('errorMessageToast').textContent = message;
        errorToast.show();
    }

    // Global variables
    let outfitToDelete = null;
    let clothingItems = [];

    // Function to get weather condition from weather code
    function getWeatherCondition(weatherCode) {
        const weatherMap = {
            0: 'CLEAR',
            1: 'CLEAR',
            2: 'PARTLY_CLOUDY',
            3: 'CLOUDY',
            45: 'FOG',
            48: 'FOG',
            51: 'DRIZZLE',
            53: 'DRIZZLE',
            55: 'DRIZZLE',
            56: 'FREEZING_DRIZZLE',
            57: 'FREEZING_DRIZZLE',
            61: 'RAIN',
            63: 'RAIN',
            65: 'RAIN',
            66: 'FREEZING_RAIN',
            67: 'FREEZING_RAIN',
            71: 'SNOW',
            73: 'SNOW',
            75: 'SNOW',
            77: 'SNOW',
            80: 'RAIN_SHOWERS',
            81: 'RAIN_SHOWERS',
            82: 'RAIN_SHOWERS',
            85: 'SNOW_SHOWERS',
            86: 'SNOW_SHOWERS',
            95: 'THUNDERSTORM',
            96: 'THUNDERSTORM',
            99: 'THUNDERSTORM'
        };
        return weatherMap[weatherCode] || 'UNKNOWN';
    }

    // Function to generate outfit suggestion
    async function generateOutfit() {
        const occasion = document.getElementById('occasion').value;
        const season = document.getElementById('season').value;
        const considerWeather = document.getElementById('weather').checked;

        if (!occasion || !season) {
            showErrorMessage('Please select both occasion and season');
            return;
        }

        try {
            // Create outfit data object
            const outfitData = {
                occasion: occasion,
                season: season,
                considerWeather: considerWeather
            };

            if (considerWeather) {
                const currentWeatherData = JSON.parse(localStorage.getItem('currentWeatherData'));
                if (!currentWeatherData) {
                    showErrorMessage('No weather data available. Please refresh weather data first.');
                    return;
                }
                outfitData.weatherDetails = {
                    temperature: currentWeatherData.temperature,
                    weatherCondition: getWeatherCondition(currentWeatherData.weathercode)
                };
            }

            // Show loading state
            const generateBtn = document.getElementById('generateOutfitBtn');
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Generating...';
            generateBtn.disabled = true;

            // Call API to generate suggestion
            const response = await fetch('/api/wardrobe/suggest-outfit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
                },
                body: JSON.stringify(outfitData)
            });

            if (!response.ok) {
                // Try to parse the error response as JSON
                const errorResponse = await response.json();
                if (errorResponse && errorResponse.message) {
                    throw new Error(errorResponse.message);
                } else {
                    throw new Error('Failed to generate outfit suggestion');
                }
            }

            const items = await response.json();

            // Update the table with the generated items
            updateTable(items);

            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('outfitModal'));
            modal.hide();

            // Show success message
            showSuccessMessage('Clothing items suggestions generated successfully!');

        } catch (error) {
            console.error('Error generating outfit:', error);
            showErrorMessage(error.message); // This will now show the custom message
        } finally {
            // Reset button state
            const generateBtn = document.getElementById('generateOutfitBtn');
            generateBtn.innerHTML = '<i class="fas fa-magic me-2"></i>Generate';
            generateBtn.disabled = false;
        }
    }

    // Function to update the items table
    function updateTable(items) {
        const tbody = document.getElementById('itemsTableBody');
        tbody.innerHTML = '';

        if (!items || items.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td colspan="8" class="text-center py-4">
                    <i class="fas fa-box-open fa-2x mb-2" style="color: var(--primary-light);"></i>
                    <p class="mb-2">No items found</p>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#outfitModal">
                        <i class="fas fa-magic me-2"></i>Generate Your First Suggestion
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
            return;
        }

        items.forEach(item => {
            const tr = document.createElement('tr');
            tr.dataset.itemId = item.id;
            tr.innerHTML = `
                <td>
                    <img src="${item.imageUrl || 'https://via.placeholder.com/50?text=No+Image'}"
                         alt="${item.name}"
                         class="img-thumbnail"
                         style="width: 50px; height: 50px; object-fit: cover;"
                         onerror="this.src='https://via.placeholder.com/50?text=No+Image'">
                </td>
                <td>${item.name}</td>
                <td>${item.categoryName || 'N/A'}</td>
                <td>${item.color || 'N/A'}</td>
                <td><span class="badge badge-season">${item.season || 'N/A'}</span></td>
                <td><span class="badge badge-occasion">${item.occasion || 'N/A'}</span></td>
                <td>${item.usageCount || 0}</td>
                <td>
                    <button class="btn btn-success btn-sm mark-used-btn" title="Mark as Used" data-item-id="${item.id}">
                        <i class="fas fa-check-circle me-1"></i> Mark as Used
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        // Add event listeners for mark as used buttons
        document.querySelectorAll('.mark-used-btn').forEach(button => {
            button.addEventListener('click', function() {
                const itemId = this.getAttribute('data-item-id');
                markItemAsUsed(itemId);
            });
        });
    }

    // Function to mark item as used
    async function markItemAsUsed(itemId) {
        try {
            const response = await fetch(`/api/wardrobe/items/${itemId}/use`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to mark item as used');
            }

            // Update the usage count in the UI
            const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
            if (row) {
                const usageCountCell = row.cells[6];
                const currentCount = parseInt(usageCountCell.textContent) || 0;
                usageCountCell.textContent = currentCount + 1;
            }

            showSuccessMessage('Item marked as used successfully!');

        } catch (error) {
            console.error('Error marking item as used:', error);
            showErrorMessage('Failed to mark item as used: ' + error.message);
        }
    }

    // Function to format date
    function formatDate(dateString) {
        if (!dateString) return 'recently';

        const date = new Date(dateString);
        const now = new Date();
        const diffInDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

        if (diffInDays === 0) return 'today';
        if (diffInDays === 1) return 'yesterday';
        if (diffInDays < 7) return `${diffInDays} days ago`;
        if (diffInDays < 30) return `${Math.floor(diffInDays / 7)} weeks ago`;
        return date.toLocaleDateString();
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Load navbar
        fetch('/page/navbar')
            .then(response => response.text())
            .then(data => {
                document.getElementById('navbar').innerHTML = data;
            })
            .catch(error => console.error('Error loading navbar:', error));

        // Generate outfit button handler
        document.getElementById('generateOutfitBtn').addEventListener('click', generateOutfit);

        // Initialize with empty table
        updateTable([]);
    });
</script>
<style>
    /* Outfit Suggestion Modal Styles */
    .outfit-form .form-group {
        margin-bottom: 1rem;
    }

    /* Empty state styling */
    .table-responsive .btn {
        margin-top: 10px;
    }

    /* Logo styling */
    .page-header img {
        max-height: 50px;
        width: auto;
    }

    /* Badge styling */
    .badge-occasion {
        background-color: #6f42c1;
        color: white;
    }

    .badge-season {
        background-color: #20c997;
        color: white;
    }

    /* Mark as used button styling */
    .mark-used-btn {
        white-space: nowrap;
    }

    /* Table image styling */
    .img-thumbnail {
        padding: 0;
        border: none;
        background-color: transparent;
    }
</style>
<script src="/js/logout.js"></script>
<script src="/js/user.js"></script>
</body>
</html>